# 📘 MCP - Master Control Plan: Trading System Pro

**תאריך עדכון אחרון:** 25/11/2025
**סטטוס מערכת:** 🟢 פעילה (Active)
**גרסה:** 3.1.0 (ATR Stability & Enhanced Validation)

---

## 1. 🎯 מטרות ויעדים (Goals)
### יעד ראשי
יצירת מערכת מסחר אלגוריתמית אוטונומית לחלוטין, רווחית ויציבה, הסוחרת בשוק המניות האמריקאי (IBKR) תוך ניהול סיכונים קפדני.

### יעדי משנה
1.  **יציבות:** ריצה רציפה ללא קריסות (הושג).
2.  **בטיחות:** מניעת הפסדים גדולים באמצעות הגנות אוטומטיות (הושג).
3.  **איכות:** סינון מניות "זבל" והתמקדות במניות נזילות ותנודתיות (הושג).
4.  **למידה:** איסוף נתונים ושיפור אסטרטגיות מבוסס AI (בתהליך).

---

## 2. 🏗️ ארכיטקטורה ורכיבים
המערכת בנויה ב-Python ומשתמשת ב-`ib_insync` לתקשורת עם TWS.

*   **`main.py`**: המוח הראשי. מנהל את הלולאה, החיבור מחדש והתיאום בין הרכיבים.
*   **`src/ib_client`**: אחראי על החיבור הטכני ל-IBKR Gateway/TWS.
*   **`src/scanner`**: סורק את השוק למציאת הזדמנויות.
    *   *שיפור אחרון:* הוספת "רשימה שחורה" לתעודות סל הפוכות ומסננים מחמירים.
*   **`src/strategy`**: מכיל את הלוגיקה של האסטרטגיות (MA, Bollinger, VWAP, ORB, Volume).
*   **`src/trade_manager`**: מנהל הביצועים. אחראי על שליחת פקודות, חישוב גודל פוזיציה וניהול סיכונים.
*   **`analyze_performance.py`**: כלי לניתוח ביצועים היסטוריים וסטטיסטיקות.

---

## 3. ⚙️ קונפיגורציה נוכחית (Current State)

### ניהול סיכונים (Risk Management) - V3.1
*   **סיכון לעסקה:** $50 (סיכון קבוע מבוסס ATR).
*   **גודל פוזיציה:** דינמי - מחושב לפי: `$50 / (מחיר - Stop Loss)`.
*   **מקסימום פוזיציות:** 5 פוזיציות פתוחות בו-זמנית.
*   **Take Profit:** 4x ATR (יחס סיכון/סיכוי 1:2).
*   **Stop Loss:** 2x ATR.
*   **סף ATR מינימלי:** 0.05 (למניעת סטופים לא-הגיוניים).
*   **הגנות נוספות:**
    *   חסימת קנייה אם המחיר מתחת לממוצע נע 200 (מגמה יורדת).
    *   חסימת כפילויות (לא קונה אם יש פקודה פתוחה).
    *   ביטול מכירה יזומה מאסטרטגיות (יציאה רק ב-SL/TP).

### הגדרות סורק (Scanner - Sniper Mode)
*   **נפח מסחר יומי:** מינימום 500,000 מניות.
*   **מחיר מניה:** עד $100.
*   **Gap (פער פתיחה):** מינימום 3%.
*   **חסימות:** תעודות סל הפוכות (SQQQ, SOXS וכו') למניעת גידור כפול.

### אסטרטגיות פעילות
1.  **MA Crossover:** חציית ממוצעים 50/200 + סינון RSI (קנייה רק אם RSI < 70).
2.  **Bollinger Bands:** היפוך מגמה (קנייה בפריצת רצועה תחתונה).
3.  **VWAP Trend:** מסחר עם המגמה התוך-יומית.
4.  **ORB:** פריצת טווח פתיחה (30 דקות ראשונות).
5.  **Volume Breakout:** פריצת שיא עם גידול בנפח (רגישות 1.2x).

---

## 4. 🗺️ תוכנית עבודה (Roadmap)

### ✅ הושלם (Done)
- [x] חיבור יציב ל-IBKR וטיפול בניתוקים.
- [x] הטמעת 5 אסטרטגיות בסיס.
- [x] יצירת סורק מניות אוטומטי.
- [x] תיקון באג "גידור כפול" (Long/Short בו זמנית).
- [x] הטמעת ניהול סיכונים (Bracket Orders).
- [x] אופטימיזציה לסורק (פרמטרים מחמירים).

### 🚧 בביצוע / טווח קצר (In Progress)
- [ ] **הרצת מבחן:** צבירת 50-100 עסקאות עם ההגדרות החדשות לבחינת Win Rate.
- [ ] **ניתוח נתונים:** שימוש ב-`analyze_performance.py` לזיהוי האסטרטגיה הרווחית ביותר.
- [ ] **שילוב AI:** בניית מודל LSTM (על בסיס המדריך ב-docs) לחיזוי הסתברותי כפילטר נוסף.

### 🔮 טווח ארוך (Future)
- [ ] **מסד נתונים:** מעבר מ-CSV ל-SQLite/PostgreSQL לניהול מהיר של היסטוריה.
- [ ] **Dashboard:** בניית ממשק גרפי (Streamlit/Dash) לצפייה בביצועים בזמן אמת.
- [ ] **Backtesting:** בניית מנוע לבדיקת אסטרטגיות על נתוני עבר לפני הפעלה בלייב.

---

## 5. 📝 יומן שינויים (Changelog)

### [25/11/2025] - גרסה 3.1.0: יציבות ATR ואימות משופר
*   **ATR Validation:** הוספת סף מינימלי (0.05) למניעת סטופים לא-הגיוניים.
*   **Logging:** הוספת תגיות DEBUG מפורטות: `[SMART_RISK]`, `[ATR_FAIL]`, `[SL_FAIL]`, `[TP_FAIL]`.
*   **Config:** הוספת `risk_per_trade: 50` לקובץ הקונפיגורציה (היה חסר).
*   **Validation:** בדיקות לוגיות ל-SL/TP (SL < מחיר < TP).
*   **Churning Fix:** ביטול מכירה יזומה מאיתותי אסטרטגיה (יציאה רק ב-SL/TP).

### [25/11/2025] - עדכון ניהול סיכונים וסורק
*   **Scanner:** עודכן לפרמטרים מחמירים (Vol > 500k, Price < 100, Gap > 3%).
*   **Risk:** הוחזרו פקודות Bracket (TP 1.5%, SL 1.0%).
*   **Cleanup:** בוצע איפוס מלא לתיק (סגירת 64 פוזיציות ישנות).

### [24/11/2025] - תיקוני יציבות
*   הוספת מנגנון Reconnect ב-`main.py`.
*   הוספת פילטר RSI לאסטרטגיית MA Crossover.
*   הגבלת כמות פוזיציות ל-5.

---

> **הערה:** קובץ זה הוא מסמך חי. יש לעדכן אותו לאחר כל שינוי מהותי בקוד או באסטרטגיה.
